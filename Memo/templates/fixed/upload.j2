{% extends "fixed/base.j2" %}
{% block article_body %}
<p>ç”»åƒã‚„æ–‡æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«ä¿å­˜ã™ã‚‹Flaskã®æ¨™æº–æ©Ÿèƒ½ã€‚</p>
<pre class="file-tag" data-tag="console"><code>mkdir -p file_upload/uploads file_upload/templates && \
t file_upload/app.py file_upload/templates/upload.j2 && \
c file_upload/app.py file_upload/templates/upload.j2 && \
cd file_upload && flr

[ file_upload ]
   â”œâ”€ ğŸ“templates
   â”‚     â””â”€ ğŸ“„upload.j2
   â”œâ”€ ğŸ“uploads
   â””â”€ ğŸ“„app.py
</code></pre>
<pre class="file-tag" data-tag="views.py"><code>from flask import Flask, request, redirect
from werkzeug.utils import secure_filename
import os

app = Flask(__name__)
UPLOAD_DIR = 'images'

@app.route('/', methods=['POST'])
def upload():
    file = request.files.get('img')
    if not file or file.filename == ':
        return 'No file', 400
		# åŒæ™‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ä¸Šæ›¸ãé˜²æ­¢ã®ãŸã‚ä»®åä»˜ä¸
    filename = secure_filename(file.filename)
    file.save(os.path.join(UPLOAD_DIR, filename))
    return 'OK'
</code></pre>
<pre class="file-tag" data-tag="templates/upload.j2"><code>&lt;form method="post" action="&#123;&#123; url_for("upload") &#125;&#125;" enctype="multipart/form-data"&gt;
    &lt;input type="file" name="img"&gt;
    &lt;button type="submit"&gt;Upload&lt;/button&gt;
&lt;/form&gt;</code></pre>
<h3 class="display-6 mt-5 mb-2"><i class="fa fa-cogs"></i> ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ©Ÿèƒ½</h3>
<ul class="list-group my-3">
<li class="list-group-item"><i class="fa fa-circle"></i> æ‹¡å¼µå­å¢—æ¸›ç®¡ç†</li>
<li class="list-group-item"><i class="fa fa-circle"></i> staticä»¥ä¸‹ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</li>
<li class="list-group-item"><i class="fa fa-circle"></i> <code>pathlib</code>ã«ã‚ˆã‚‹ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”»åƒä¸€è¦§è¡¨ç¤º</li>
<li class="list-group-item"><i class="fa fa-circle"></i> ç”»åƒå‰Šé™¤ãƒœã‚¿ãƒ³</li>
<li class="list-group-item"><i class="fa fa-circle"></i> ç”»åƒç ´æãƒã‚§ãƒƒã‚¯ã€æ‹¡å¼µå­å½è£…æ¤œå‡ºã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–</li>
<li class="list-group-item"><i class="fa fa-circle"></i> ã‚µãƒ ãƒã‚¤ãƒ«ä½œæˆã€€ã‚µãƒ ãƒã‚¤ãƒ«ã‹ã‚‰æ¨™æº–ç”»åƒåˆ‡æ›¿ãˆè¡¨ç¤º</li>
</ul>
<pre class="file-tag" data-tag="console"><code>mkdir -p static/images/thumbs && r uploads && pi pillow
[ file_upload ]
   â”œâ”€ ğŸ“static
   â”‚     â””â”€ ğŸ“images # é€šå¸¸ç”»åƒ
   â”‚           â””â”€ ğŸ“thumbs # ã‚µãƒ ãƒã‚¤ãƒ«ç”»åƒ
   â”œâ”€ ğŸ“templates
   â”‚     â””â”€ ğŸ“„upload.j2
   â””â”€ ğŸ“„app.py
</code></pre>
  <pre class="file-tag" data-tag="app.py"><code>from flask import Flask, render_template, request, redirect, url_for
from werkzeug.utils import secure_filename
from pathlib import Path

# pip install pillow
from PIL import Image

app = Flask(__name__)

# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å…ˆã®ãƒ‘ã‚¹
UPLOAD_DIR = Path('static/images')
# ã‚µãƒ ãƒã‚¤ãƒ«ç”¨ã®ãƒ‘ã‚¹
THUMB_DIR = Path('static/images/thumbs')
THUMB_DIR.mkdir(exist_ok=True)

# æ¤œè¨¼ç”¨æ‹¡å¼µå­
ALLOWED_FORMATS = {'JPEG', 'PNG', 'WEBP'}

# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ¤œè¨¼(æ‹¡å¼µå­å½è£…é˜²æ­¢)
def is_valid_image(file_storage) -> bool:
    try:
        img = Image.open(file_storage)
        img.verify()  # ç”»åƒç ´æãƒ»å½è£…æ¤œå‡º
        return img.format in ALLOWED_FORMATS
    except Exception:
        return False

# ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆé–¢æ•°
def create_thumbnail(src: Path, size=(100, 100)):
    thumb_path = THUMB_DIR / src.name
    with Image.open(src) as img:
        img.thumbnail(size)
        img.save(thumb_path)

# ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç”¨ãƒˆãƒƒãƒ—
@app.route('/')
def index():
    return redirect(url_for('upload'))

@app.route('/upload', methods=['GET', 'POST'])
def upload():
    images = sorted((
        p for p in UPLOAD_DIR.iterdir()
        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã€æ¥å°¾è¾ã«ä»¥ä¸‹ã®æ‹¡å¼µå­ãŒå«ã¾ã‚Œã¦ã„ã‚Œã°
        if p.is_file() and p.suffix.lower() in {'.jpg', '.png', '.webp'}
      ),
      key=lambda p: p.stat().st_mtime,  # æ›´æ–°æ—¥æ™‚é †
      reverse=True,  # åŒæ—¥ã®å ´åˆã¯æ–°ã—ã„é †
    )
    # static ã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã‚’POSIXå½¢å¼ã¸å¤‰æ›
    image_urls = [p.relative_to('static').as_posix() for p in images]
    thumb_urls = [
        (THUMB_DIR / p.name).relative_to('static').as_posix()
        for p in images
    ]
    image_both = [
        {
            'image': (UPLOAD_DIR / p.name).relative_to('static').as_posix(),
            'thumb': (THUMB_DIR / p.name).relative_to('static').as_posix(),
            'name': p.name,
        }
        for p in images
    ]
    if request.method == 'POST':
        file = request.files.get('img')
        if not file or file.filename == '':
            return 'ç©ºé€ä¿¡ã‹ãƒ•ã‚¡ã‚¤ãƒ«åãŒã‚ã‚Šã¾ã›ã‚“', 400
        if not is_valid_image(file):
            return 'ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æ‹’å¦ã•ã‚Œã¾ã—ãŸ', 400

        # verifyã¯ãƒ•ã‚¡ã‚¤ãƒ«æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯å°‚ç”¨ã®ãŸã‚
        # ãã®å¾Œã¯ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚¤ãƒ³ã‚¿ã‚’å…ˆé ­ã«å¿…ãšå·»ãæˆ»ã™
        file.seek(0)

        filename = secure_filename(file.filename)
        save_path = UPLOAD_DIR / filename
        file.save(save_path)
        # ã‚µãƒ ãƒã‚¤ãƒ«ç”Ÿæˆ
        create_thumbnail(save_path)

        return redirect(url_for('upload'))
    return render_template('upload.j2', images=image_urls, thumbs=thumb_urls, imageboth=image_both)

# å‰Šé™¤
@app.route('/delete/<name>', methods=['POST'])
def delete(name):
    filename = secure_filename(name)

    image_path = UPLOAD_DIR / filename
    thumb_path = THUMB_DIR / filename

    if image_path.exists():
        image_path.unlink()
    if thumb_path.exists():
        thumb_path.unlink()

    return redirect(url_for('upload'))
</code></pre>
<pre class="file-tag" data-tag="templates/upload.j2"><code>&lt;form method=&quot;post&quot; action=&quot;&#123;&#123; url_for(&#x27;upload&#x27;) &#125;&#125;&quot; enctype=&quot;multipart/form-data&quot;&gt;
  &lt;input type=&quot;file&quot; name=&quot;img&quot;&gt;
  &lt;button type=&quot;submit&quot;&gt;ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰&lt;/button&gt;
&lt;/form&gt;
&lt;p&gt;é€šå¸¸ç”»åƒ: &#123;&#123; images or &#x27;ã¾ã ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã›ã‚“&#x27; &#125;&#125;&lt;/p&gt;
&#123;&#37; for img in images &#37;&#125;
  &lt;div&gt;
    &lt;img src=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=img) &#125;&#125;&quot; width=&quot;200&quot; height=&quot;&quot; alt=&quot;&quot;&gt;
    &lt;form method=&quot;post&quot; action=&quot;&#123;&#123; url_for(&#x27;delete&#x27;, name=img.split(&#x27;/&#x27;)[-1] ) &#125;&#125;&quot;&gt;
      &lt;button type=&quot;submit&quot;&gt;å‰Šé™¤&lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&#123;&#37; endfor &#37;&#125;
&lt;p&gt;ã‚µãƒ ãƒã‚¤ãƒ«: &#123;&#123; thumbs or &#x27;ã¾ã ã‚¢ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã›ã‚“&#x27; &#125;&#125;&lt;/p&gt;
&#123;&#37; for thu in thumbs &#37;&#125;
  &lt;div&gt;
    &lt;img src=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=thu) &#125;&#125;&quot; width=&quot;&quot; height=&quot;&quot; alt=&quot;&quot;&gt;
    &lt;form method=&quot;post&quot; action=&quot;&#123;&#123; url_for(&#x27;delete&#x27;, name=thu.split(&#x27;/&#x27;)[-1] ) &#125;&#125;&quot;&gt;
      &lt;button type=&quot;submit&quot;&gt;å‰Šé™¤&lt;/button&gt;
    &lt;/form&gt;
  &lt;/div&gt;
&#123;&#37; endfor &#37;&#125;
&#123;&#37; for item in imageboth &#37;&#125;
  &lt;a href=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=item.image) &#125;&#125;&quot;&gt;
    &lt;img src=&quot;&#123;&#123; url_for(&#x27;static&#x27;, filename=item.thumb) &#125;&#125;&quot; width=&quot;&quot; height=&quot;&quot; alt=&quot;&quot;&gt;
  &lt;/a&gt;
  &lt;form method=&quot;post&quot; action=&quot;&#123;&#123; url_for(&#x27;delete&#x27;, name=item.name) &#125;&#125;&quot;&gt;
    &lt;button type=&quot;submit&quot;&gt;å‰Šé™¤&lt;/button&gt;
  &lt;/form&gt;
&#123;&#37; endfor &#37;&#125;</code></pre>
<p>ä¸€æ„ãªæ—¥ä»˜ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä»˜ä¸(jpgã®ã¿å¯¾å¿œ)</p>
<pre class="file-tag" data-tag="app.py"><code>from datetime import datetime
filename = photos.save(request.files[&#x27;photo&#x27;], name=datetime.now().strftime(&quot;%Y%m%d_%H%M%S_&quot;) + &#x27;.jpg&#x27;)</code></pre>
<p>ãƒ©ãƒ³ãƒ€ãƒ ãªä¸€æ„ãƒ•ã‚¡ã‚¤ãƒ«åä»˜ä¸</p>
<pre class="file-tag" data-tag="app.py"><code>filename = photos.save(request.files[&#x27;photo&#x27;], name=&quot;unique_&quot;, chunk_size=4096)</code></pre>
{% endblock %}
