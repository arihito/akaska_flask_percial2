{% extends "fixed/base.j2" %}

{% block article_body %}
<h3 class="display-6 mt-5 mb-2"><i class="fa fa-cogs"></i>APIãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—</h3>
<ul class="list-group my-3">
<li class="list-group-item">â‘  <strong><a href="https://console.cloud.google.com/">Google Cloud Console</a></strong>ã®ä¸Šéƒ¨æ¤œç´¢çª“ã«ã€ŒOAuthã€ã¨å…¥åŠ›ã—ã€ŒOAuthåŒæ„ç”»é¢ã€ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚</li>
<li class="list-group-item">â‘¡ ä¸­å¤®ã®é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦<strong>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID</strong>ã‚’ä½œæˆ</li>
<li class="list-group-item">â‘¢ ã‚¢ãƒ—ãƒªåã¯ä»»æ„ã€Œflask_testã€ã€å¯¾è±¡ã€Œå¤–éƒ¨ã€ãªã©ã€æœ€å¾Œã«ã€ŒOAuthã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã€ã‚’æŠ¼ã™ã€‚</li>
<li class="list-group-item">â‘£ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¨®é¡ã¯ã€Œã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€åå‰ã‚’ã€Œflask_testã€</li>
</ul>
<p>â‘¤ ä½œæˆæ¸ˆã¿ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã‚’ä»»æ„ã ãŒã€ä»Šå›ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã™ã‚‹ã€‚<code>localhost</code>ã¨<code>127.0.0.1</code>ã¯ç•°ãªã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ãªã‚‹ãŸã‚ã€ä¸¡æ–¹ç™»éŒ²ã‚’ã—ã¦ãŠãã€‚<mark class="highlight-yellow_background">æœ¬ç•ªURLã§ã¯<code>HTTPS</code>ã«ã—ãªã„ã¨å¯©æŸ»ã§å¼¾ã‹ã‚Œã‚‹ã€‚</mark></p>
<pre class="file-tag" data-tag="Google Cloud Console"><code>http://localhost:5000/auth/google/callback
http://127.0.0.1:5000/auth/google/callback</code></pre>
<p>æœ€å¾Œã«ä½œæˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨<code>CLIENT_ID</code>ã¨<code>CLIENT_SECRET</code> ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚</p>
<pre class="file-tag" data-tag="test.txt"><code># CLIENT_ID
156918646905-hpe...edhk8nk9.apps.googleusercontent.com
# CLIENT_SECRET
GOCSPX-kIIkglNa4Nyz8t67y...</code></pre>
<p>æœ€ã‚‚å®Ÿè£…ãŒç°¡å˜ãªã®ã¯<code>Authlib</code>ã§ã€OAuth2.0å…¬å¼ã«è¿‘ã„æ¨™æº–ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§Googleã¨ç›¸æ€§ã‚‚è‰¯ã„ã€‚ã‚»ã‚­ãƒ¥ã‚¢ãªã‚³ãƒ¼ãƒ‰ã‚’ç’°å¢ƒå¤‰æ•°ã«é…ç½®ã—ãŸæœ€å°æ§‹æˆã€‚<code>Authlib</code>å†…ã®<code>flask-jwt-extended</code>ãŒ(2026/01ç¾åœ¨)flask3ã«å¯¾å¿œã—ã¦ã„ãªã„ãŸã‚2ç³»ã«å›ºå®šã—ã¦ãŠãã€‚</p>
<pre class="file-tag" data-tag="console"><code>mkdir google_oauth/templates &amp;&amp; t google_oauth/.env t google_oauth/.gitignore google_oauth/app.py google_oauth/templates/profile.py &amp;&amp; cd google_oauth &amp;&amp; \ 
pi flask==2.3.3 Authlib python-dotenv

[ google_oauth ]
   â”œâ”€ ğŸ“templates
   â”‚     â””â”€ ğŸ“„profile.j2
   â”œâ”€ ğŸ“„.env
   â””â”€ ğŸ“„app.py</code></pre>
<pre class="file-tag" data-tag=".env"><code>FLASK_SECRET_KEY=dev-secret-key
GOOGLE_CLIENT_ID=xxxxxxxx.apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=xxxxxxxx
</code></pre>
<p>ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ã‚¢ãƒ‰ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã¨Githubã«ãƒ—ãƒƒã‚·ãƒ¥åˆ¶é™ãŒã‹ã‹ã‚‹ãŸã‚ã€åˆã‚ã‹ã‚‰é™¤å¤–ã™ã‚‹ã€‚</p>
<pre class="file-tag" data-tag=".gitignore"><code>.env
__pycache__</code></pre>
<pre class="file-tag" data-tag="app.py"><code>from flask import Flask, render_template, redirect, url_for, session
from authlib.integrations.flask_client import OAuth
import os
from dotenv import load_dotenv

load_dotenv()

app = Flask(__name__)
app.secret_key = os.environ[&#x27;FLASK_SECRET_KEY&#x27;]

oauth = OAuth(app)

oauth.register(
    name=&#x27;google&#x27;,
    client_id=os.environ[&#x27;GOOGLE_CLIENT_ID&#x27;],
    client_secret=os.environ[&#x27;GOOGLE_CLIENT_SECRET&#x27;],
    access_token_url=&#x27;https://oauth2.googleapis.com/token&#x27;,
    authorize_url=&#x27;https://accounts.google.com/o/oauth2/v2/auth&#x27;,
    api_base_url=&#x27;https://www.googleapis.com/oauth2/v2/&#x27;,
    server_metadata_url=&#x27;https://accounts.google.com/.well-known/openid-configuration&#x27;,
    client_kwargs={
        &#x27;scope&#x27;: &#x27;openid email profile&#x27;
    }
)

# ãƒˆãƒƒãƒ—ã§ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã‹ã‚’ç¢ºèªã—ã€æœªãƒ­ã‚°ã‚¤ãƒ³ãªã‚‰ãƒªãƒ³ã‚¯ã‹ã‚‰/loginã«ã‚¢ã‚¯ã‚»ã‚¹
@app.route(&#x27;/&#x27;)
def index():
    user = session.get(&#x27;user&#x27;)
    if user:
        return f&#x27;{user[&quot;email&quot;]}ã¨ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã§ã™ã€‚&#x27;
    return &#x27;ã¾ã ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“ã€‚&lt;a href=&quot;/login&quot;&gt;Googleã«ãƒ­ã‚°ã‚¤ãƒ³&lt;/a&gt;&#x27;

# Googleã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ(URIã¯Googleã®è¨­å®šã¨Flaskå´ãŒä¸€è‡´ã—ã¦ã„ãªã„ã¨ã‚¨ãƒ©ãƒ¼)
@app.route(&#x27;/login&#x27;)
def login():
    redirect_uri = url_for(&#x27;auth_google&#x27;, _external=True)
    return oauth.google.authorize_redirect(redirect_uri)

@app.route(&#x27;/auth/callback&#x27;)
def auth_callback():
		token = oauth.google.authorize_access_token()
    user_info = oauth.google.get(&#x27;userinfo&#x27;).json()
    session[&#x27;user&#x27;] = user_info
    return redirect(url_for(&#x27;index&#x27;))

# GoogleãŒè¿”ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åŸºã«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
@app.route(&#x27;/auth/google/callback&#x27;)
def auth_google():
    token = oauth.google.authorize_access_token()
    user_info = oauth.google.get(&#x27;userinfo&#x27;).json()

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’ä¿æŒã—ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†
    session[&#x27;user&#x27;] = {
        &#x27;id&#x27;: user_info[&#x27;id&#x27;],
        &#x27;email&#x27;: user_info[&#x27;email&#x27;],
        &#x27;name&#x27;: user_info[&#x27;name&#x27;],
        &#x27;picture&#x27;: user_info[&#x27;picture&#x27;],
    }
    return redirect(url_for(&#x27;profile&#x27;))

# ãƒã‚¤ãƒšãƒ¼ã‚¸ã§ã¯ãƒ¦ãƒ¼ã‚¶æƒ…å ±ãŒã‚ã‚Œã°è¡¨ç¤º
@app.route(&#x27;/profile&#x27;)
def profile():
    user = session.get(&#x27;user&#x27;)
    if not user:
        return redirect(url_for(&#x27;login&#x27;))
    return render_template(&#x27;profile.j2&#x27;, user=user)

# ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
@app.route(&#x27;/logout&#x27;)
def logout():
    session.clear()
    return redirect(&#x27;/&#x27;)

if __name__ == &#x27;__main__&#x27;:
    app.run(debug=True)</code></pre>
<pre class="file-tag" data-tag="templates/profile.j2"><code>&lt;h1&gt;ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ&lt;/h1&gt;
&lt;p&gt;&#123;&#123; user.name &#125;&#125; (&#123;&#123; user.email &#125;&#125;)&lt;/p&gt;
&lt;img src=&quot;&#123;&#123; user.picture &#125;&#125;&quot;&gt;
&lt;p&gt;&lt;a href=&quot;&#123;&#123; url_for(&#x27;logout&#x27;) &#125;&#125;&quot;&gt;ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ&lt;/a&gt;&lt;/p&gt;</code></pre>
<p>ä¸Šè¨˜ã®<code>auth_callback</code>ã‚„<code>auth_google</code>ãƒ¡ã‚½ãƒƒãƒ‰å†…ã«ã‚ã‚‹å¤‰æ•°<code>token</code>ã«ä»£å…¥ã—ã¦ã‚‚æœªä½¿ç”¨ã®çŠ¶æ…‹ã ãŒã€å–å¾—ã—ã¦ãŠãã“ã¨ã§ã€OAuthã®çµæœã‚„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã‚„ã™ããªã‚Šã€JWTç™ºè¡Œãªã©ã®å‡¦ç†ã«æ‹¡å¼µã—ã‚„ã™ããªã‚‹ã€‚ãŸã èª¤è§£ã‚’ä¸ãˆãŸããªã„ã®ã§ã‚ã‚Œã°ã€æ˜ç¤ºçš„ã«æœªä½¿ç”¨ã§ã‚ã‚‹<code>_</code> ã«ä»£å…¥ã—ã¦ãŠãã€‚</p>
<h3 class="display-6 mt-5 mb-2"><i class="fa fa-cogs"></i>ãƒ¦ãƒ¼ã‚¶ã®ä¸€å…ƒç®¡ç†</h3>
<p>flask_loginã§é€šå¸¸ã®ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹å ´åˆã¯ã€ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã‚„views/templateãªã©ã§<code>ãƒ¦ãƒ¼ã‚¶æƒ…å ±ãŒsessionã¨current_userã§äºŒå…ƒåŒ–ã—ç…©é›‘ã«ãªã‚‹</code>ãŸã‚ã€sessionã‚’ä½¿ç”¨ã›ãšä¸€å…ƒç®¡ç†ãŒå¿…é ˆã¨ãªã£ã¦ãã‚‹ã€‚</p>
<pre class="file-tag" data-tag="templates/profile.j2"><code>@auth_bp.route('/auth/google/callback')
def auth_google():
    token = oauth.google.authorize_access_token()
    user_info = oauth.google.get('userinfo').json()

    oauth_sub = user_info['id']
    email = user_info['email']
    name = user_info['name']

    user = User.query.filter_by(
        oauth_provider='google',
        oauth_sub=oauth_sub
    ).first()

    if not user:
        user = User(
            username=name,
            email=email,
            oauth_provider='google',
            oauth_sub=oauth_sub
        )
        db.session.add(user)
        db.session.commit()

    login_user(user)
    flash('Googleã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ', 'success')
    return redirect(url_for('memo.index'))</code></pre>
<p><code>auth_callback</code>ã‚„<code>auth_google</code>ãƒ¡ã‚½ãƒƒãƒ‰å†…ã«ã‚ã‚‹å¤‰æ•°tokenã«ä»£å…¥ã—ã¦ã‚‚æœªä½¿ç”¨ã®çŠ¶æ…‹ã ãŒã€å–å¾—ã—ã¦ãŠãã“ã¨ã§ã€OAuthã®çµæœã‚„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºèªã—ã‚„ã™ããªã‚Šã€JWTç™ºè¡Œãªã©ã®å‡¦ç†ã«æ‹¡å¼µã—ã‚„ã™ããªã‚‹ã€‚ãŸã èª¤è§£ã‚’ä¸ãˆãŸããªã„ã®ã§ã‚ã‚Œã°ã€æ˜ç¤ºçš„ã«æœªä½¿ç”¨ã§ã‚ã‚‹<code>_</code>ã«ä»£å…¥ã—ã¦ãŠãã€‚</p>
<pre class="file-tag" data-tag="templates/profile.j2"><code># æ˜ç¤ºçš„ã«ä½¿ã‚ãªã„ã“ã¨ã‚’ç¤ºã™
_ = oauth.google.authorize_access_token()

# å†…å®¹
{
  &#x27;access_token&#x27;: &#x27;ya29.a0...&#x27;, # é‡è¦
  &#x27;expires_in&#x27;: 3599,
  &#x27;scope&#x27;: &#x27;openid email profile&#x27;,
  &#x27;token_type&#x27;: &#x27;Bearer&#x27;,
  &#x27;id_token&#x27;: &#x27;eyJhbGciOiJSUzI1NiIs...&#x27; # é‡è¦
}</code></pre>
<h3 class="display-6 mt-5 mb-2"><i class="fa fa-cogs"></i>ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™</h3>
<p>ä¸Šè¨˜ã®ã¾ã¾ã§ã‚‚ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã«URLã§ã®ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã‚‹ã¨ã€<code>user</code>ã‚’å–å¾—ã—ã¦ã„ãªã„ãŸã‚ã€GoogleIDã®é¸æŠç”»é¢ã«è‡ªå‹•ã§åˆ‡ã‚Šæ›¿ã‚ã‚‹ãŸã‚ã€çµæœçš„ã«ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã¯ã§ãã¦ã„ã‚‹ãŒã€<code>user</code>ã‚’å¿…è¦ã¨ã—ãªã„ä¼šå“¡å°‚ç”¨ãƒšãƒ¼ã‚¸ãŒã‚ã£ãŸå ´åˆã€ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¦ã—ã¾ã†ãŸã‚ã€å®‰å…¨ã®ãŸã‚ã«ä»¥ä¸‹ã®ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’å…¨ã¦ã«å®Ÿè£…ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚</p>
<pre class="file-tag" data-tag="templates/.j2 app.py"><code>from functools import wraps
from flask import redirect, session, url_for

# ãƒ­ã‚°ã‚¤ãƒ³å¿…é ˆãƒšãƒ¼ã‚¸ã®ä¿è­·
def login_required(fn):
    @wraps(fn)
    def wrapper(*args, **kwargs):
        if &quot;user&quot; not in session:
            return redirect(url_for(&#x27;login&#x27;))
        return fn(*args, **kwargs)
    return wrapper</code></pre>
<pre class="file-tag" data-tag="templates/.j2 app.py"><code># ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ã®ä½¿ç”¨ä¾‹
@app.route(&#x27;/dashboard&#x27;)
@login_required
def dashboard():
    return &#x27;Secret page&#x27;</code></pre>
{% endblock %}
