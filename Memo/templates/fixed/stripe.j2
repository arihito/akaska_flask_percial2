{% extends "fixed/base.j2" %}
{% block article_body %}
<h2>Stripeã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆ</h2>
<p>Flaskã¨ã®ç›¸æ€§ãŒæœ€ã‚‚è‰¯ãã€Stripeã¯ä¸–ç•Œçš„ã«åˆ©ç”¨è€…ãŒå¤šã„æ±ºæ¸ˆAPIã§å…¬å¼ SDKã€Œ<a href="https://qiita.com/sugo/items/3659e8baee2d053041f5">stripe-python</a>ã€ãŒå……å®Ÿã—ã¦ãŠã‚Šã€blueprintã«çµ„ã¿è¾¼ã¿ã‚„ã™ã„ã€‚</p>
<h3 class="display-6 mt-5 mb-2"><i class="fa fa-cogs"></i>äº‹å‰æº–å‚™</h3>
<p>Stripeã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã—ã€ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ­ã‚°ã‚¤ãƒ³<strong>ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰(Test mode)</strong>ã‚’æœ‰åŠ¹åŒ–</p>
<img src="/static/images/fixed/stripe_mypage.png" alt="" width="100%" height="">
<p>å·¦ä¸Šã®ãƒ¦ãƒ¼ã‚¶ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã®åˆ‡ã‚Šæ›¿ãˆã‹ã‚‰ä»¥ä¸‹ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŒã€ãã‚Œãã‚Œå½¹å‰²ã¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒç•°ãªã‚‹ã€‚ä»Šå›ã¯ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã¾ã§ä½¿ç”¨ã™ã‚‹å¿…è¦ã¯ç„¡ã<mark class="highlight-default"><mark class="highlight-yellow_background">ãƒ†ã‚¹ãƒˆç’°å¢ƒã§å……åˆ†</mark></mark>ã€‚</p>
<ul class="list-group my-3">
<li class="list-group-item"><i class="fa fa-circle"></i><strong>ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹</strong>ã®ä½œæˆï¼šã‚¢ã‚«ã‚¦ãƒ³ãƒˆã”ã¨ã«ç‹¬ç«‹ã—ãŸæœ¬ç•ªã«è¿‘ã„æ¤œè¨¼ç’°å¢ƒ</li>
<li class="list-group-item"><i class="fa fa-circle"></i><strong>ãƒ†ã‚¹ãƒˆ</strong>ç’°å¢ƒï¼šåŒä¸€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§API ãƒ¬ãƒ™ãƒ«ã®å­¦ç¿’ãƒ‡ãƒ¢å‘ã‘æ±ºæ¸ˆãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰</li>
</ul>
<p>ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã®å³ä¸Šã«é–‹ç™ºè€…å‘ã‘ã®<code>pk</code>ã§å§‹ã¾ã‚‹<strong>å…¬é–‹å¯èƒ½ã‚­ãƒ¼</strong>ã¨<code>sk</code>ã§å§‹ã¾ã‚‹<strong>ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼</strong>ã®ä¸€éƒ¨ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ä»¥ä¸‹ã®app.pyã®<code>STRIPE_SECRET_KEY</code>ã«æ–‡å­—åˆ—ã¨ã—ã¦å¼µã‚Šä»˜ã‘ã¦å·®ã—æ›¿ãˆã‚‹ã€‚</p>
<pre class="file-tag" data-tag=".env"><code># STRIPE_SECRET_KEY
sk_test_51MGulBGk0Ak3RlmkMa8x1S1gVKLS1KFYKZQRV2...</code></pre>
<ul class="list-group my-3">
<li class="list-group-item">â‘  ãƒ–ãƒ©ã‚¦ã‚¶ã§è³¼å…¥ãƒœã‚¿ãƒ³æŠ¼ä¸‹</li>
<li class="list-group-item">â‘¡ Flaskä¸Šã§å•†å“ã®è³¼å…¥æƒ…å ±ã¨ãªã‚‹Checkout Sessionã‚’ä½œæˆ</li>
<li class="list-group-item">â‘¢ Stripeã§æ±ºæ¸ˆç”»é¢ã«è‡ªå‹•ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆè¡¨ç¤º</li>
<li class="list-group-item">â‘£ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚«ãƒ¼ãƒ‰æƒ…å ±(ãƒ€ãƒŸãƒ¼ãƒ†ã‚¹ãƒˆç”¨)ã‚’å…¥åŠ›</li>
<li class="list-group-item">â‘¤ Stripeä¸Šã§success / cancelã¸ã®URLã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ</li>
</ul>
<p>stripeãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯flask3ã§ã‚‚å•é¡Œç„¡ãç¨¼åƒã™ã‚‹ã€‚ä»¥ä¸‹ã¯æ±ºæ¸ˆã®ç¨¼åƒç¢ºèªã®ãŸã‚ã®æœ€å°æ§‹æˆã€‚</p>
<pre class="file-tag" data-tag="console"><code>mkdir -p stripe_checkout/templates &amp;&amp; \
t stripe_checkout/templates/index.j2 stripe_checkout/app.py &amp;&amp; \
cd stripe_checkout &amp;&amp; pi flask stripe

[ stripe_checkout ]
   â”œâ”€ ğŸ“templates
   â”‚     â””â”€ ğŸ“„index.j2
   â””â”€ ğŸ“„app.py</code></pre>
<pre class="file-tag" data-tag="templates/index.j2"><code>&lt;form action=&quot;&#123;&#123; url_for(&#x27;create_checkout_session&#x27;) &#125;&#125;&quot; method=&quot;POST&quot;&gt;
    &lt;button type=&quot;submit&quot;&gt;600å††ã‚’æ”¯æ‰•ã†&lt;/button&gt;
&lt;/form&gt;</code></pre>
<p>APIã‚­ãƒ¼ã‚’app.pyã«ç›´æ›¸ãã—ã¦ã‚¢ãƒ‰ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã¨Githubã«ãƒ—ãƒƒã‚·ãƒ¥åˆ¶é™ãŒã‹ã‹ã‚‹ã®ã§æ³¨æ„ã™ã‚‹ã€‚</p>
<pre class="file-tag" data-tag="app.py"><code>from flask import Flask, render_template, redirect, url_for
import stripe
app = Flask(__name__)

stripe.api_key = &quot;STRIPE_SECRET_KEY&quot; # ã“ã“ã«ã‚³ãƒ”ãƒ¼ã—ãŸã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã‚‹

@app.route(&#x27;/&#x27;)
def index():
    return render_template(&#x27;index.j2&#x27;)

@app.route(&#x27;/create-checkout-session/&lt;int:total&gt;&#x27;, methods=[&#x27;POST&#x27;])
def create_checkout_session(total):
		# checkout sessionã®ä½œæˆ
    session = stripe.checkout.Session.create(
        payment_method_types=[&#x27;card&#x27;],
        line_items=[
            {
                &#x27;price_data&#x27;: {
                    &#x27;currency&#x27;: &#x27;jpy&#x27;,
                    &#x27;product_data&#x27;: {
                        &#x27;name&#x27;: &#x27;ã¿ãŸã‚‰ã—å›£å­&#x27;,
                    },
                    &#x27;unit_amount&#x27;: 600,  # å††å˜ä½
                },
                &#x27;quantity&#x27;: 1, # è³¼å…¥æ•°
            }
        ],
        mode=&#x27;payment&#x27;,
        # æˆåŠŸç”»é¢ã¨ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”»é¢ã«é·ç§»ã€‚_externalã¯Stripeã‹ã‚‰æˆ»ã‚‹ãŸã‚ã®ãŠä½œæ³•
        success_url=url_for(&#x27;success&#x27;, _external=True),
        cancel_url=url_for(&#x27;cancel&#x27;, _external=True),
    )

    return redirect(session.url, code=303)

@app.route(&#x27;/success&#x27;)
def success()
		return &#x27;æ±ºæ¸ˆãŒæˆåŠŸã—ã¾ã—ãŸ&#x27;

@app.route(&#x27;/cancel&#x27;)
def cancel():
    return &#x27;æ±ºæ¸ˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ&#x27;</code></pre>
<p>SripeãŒç”¨æ„ã—ã¦ã„ã‚‹ãƒ€ãƒŸãƒ¼ã‚«ãƒ¼ãƒ‰ã§æ±ºæ¸ˆé·ç§»ã®ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã‚’è©¦ã—ã¦ã¿ã‚‹ã€‚ã‚«ãƒ¼ãƒ‰ç•ªå·ã¯ãƒ†ã‚¹ãƒˆç”¨ã®<code>4242 4242 4242 4242</code> ã§ã€ãã®ä»–ã®æœ‰åŠ¹æœŸé™/cvc3æ¡/è‹±å­—åã®å…¥åŠ›æ¬„ã¯å…¨ã¦ä»»æ„ã§OKã€‚</p>
<h3 class="display-6 mt-5 mb-2"><i class="fa fa-cogs"></i>Blueprint/Webhook</h3>
<pre class="file-tag" data-tag="console"><code>mkdir -p stripe_webhook/checkout stripe_webhook/templates &amp;&amp; \
t stripe_webhook/app.py stripe_webhook/extensions.py stripe_webhook/checkout/routes.py stripe_webhook/checkout/webhook.py stripe_webhook/templates/index.j2 &amp;&amp; \
cd stripe_webhook &amp;&amp; pi flask stripe

[ stripe_webhook ]
   â”œâ”€ ğŸ“checkout
   â”‚   â”œâ”€ ğŸ“„routes.py
   â”‚   â””â”€ ğŸ“„webhook.py
   â”œâ”€ ğŸ“templates
   â”‚     â””â”€ ğŸ“„index.j2
   â”œâ”€ ğŸ“„app.py
   â””â”€ ğŸ“„extensions.py # ã‚»ã‚­ãƒ¥ã‚¢æƒ…å ±ã®éš”é›¢</code></pre>
<pre class="file-tag" data-tag="templates/index.j2"><code>&lt;h2&gt;ã¿ãŸã‚‰ã—å›£å­ï¼ˆ1æœ¬ï¼‰600å††&lt;/h2&gt;

&lt;ul id=&quot;toppings&quot;&gt;
  &lt;li data-id=&quot;kinako&quot; data-price=&quot;0&quot;&gt;ããªã“ï¼ˆç„¡æ–™ï¼‰&lt;/li&gt;
  &lt;li data-id=&quot;matcha&quot; data-price=&quot;50&quot;&gt;æŠ¹èŒ¶ï¼ˆ+50å††ï¼‰&lt;/li&gt;
  &lt;li data-id=&quot;black&quot; data-price=&quot;100&quot;&gt;é»’ã”ã¾ï¼ˆ+100å††ï¼‰&lt;/li&gt;
  &lt;li data-id=&quot;special&quot; data-price=&quot;150&quot;&gt;ç‰¹è£½ï¼ˆ+150å††ï¼‰&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;é¸æŠãƒˆãƒƒãƒ”ãƒ³ã‚°æ•°ï¼š&lt;span id=&quot;count&quot;&gt;0&lt;/span&gt; / 6&lt;/p&gt;
&lt;p&gt;åˆè¨ˆé‡‘é¡ï¼š&lt;span id=&quot;total&quot;&gt;600&lt;/span&gt; å††&lt;/p&gt;

&lt;button id=&quot;pay&quot;&gt;æ±ºæ¸ˆã™ã‚‹&lt;/button&gt;

&lt;script&gt;
const BASE_PRICE = 600;
const MAX_TOPPINGS = 6;

let selected = {};
let toppingCount = 0;

const totalEl = document.getElementById(&quot;total&quot;);
const countEl = document.getElementById(&quot;count&quot;);

document.querySelectorAll(&quot;#toppings li&quot;).forEach(li =&gt; {
  li.addEventListener(&quot;click&quot;, () =&gt; {
	  /* liã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨idã¨ä¾¡æ ¼ã‚’å€‹ã€…ã«å–å¾— */
    const id = li.dataset.id;
    const price = Number(li.dataset.price);

		/* é¸æŠæ¸ˆã¿ã«è¿½åŠ  */
    if (!selected[id]) selected[id] = { qty: 0, price };

		/* å€‹ã€…ã®é¸æŠãŒ2ä»¥ä¸Šã€ã‚‚ã—ãã¯å…¨ä½“ã§6å€‹ä»¥ä¸Šã§ã‚ã‚Œã°è¿½åŠ çµ‚äº† */
    if (selected[id].qty &gt;= 2 || toppingCount &gt;= MAX_TOPPINGS) {
      return;
    }

    selected[id].qty += 1;
    toppingCount += 1;
		/* åˆè¨ˆé‡‘é¡ã®æ›´æ–° */
    updateTotal();
  });
});

function updateTotal() {
	/* ãŠå›£å­ã®åŸºæœ¬æ–™é‡‘ */
  let total = BASE_PRICE;
  /* é¸æŠæ¸ˆã¿ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°æ–™é‡‘ã‚’åŠ ç®— */
  Object.values(selected).forEach(item =&gt; {
    total += item.qty * item.price;
  });

  totalEl.textContent = total;
  countEl.textContent = toppingCount;
}

/* è³¼å…¥ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰JSONã§POSTé€ä¿¡ */
document.getElementById(&quot;pay&quot;).addEventListener(&quot;click&quot;, () =&gt; {
  fetch(&quot;/checkout/create&quot;, {
    method: &quot;POST&quot;,
    headers: { &quot;Content-Type&quot;: &quot;application/json&quot; },
    body: JSON.stringify(selected)
  })
  .then(res =&gt; res.json())
  .then(data =&gt; window.location = data.url);
});
&lt;/script&gt;</code></pre>
    <pre class="file-tag" data-tag="templates/.j2 app.py"><code>import stripe
import os
stripe.api_key = os.environ.get(&quot;STRIPE_SECRET_KEY&quot;, &quot;sk_test_xxxxx&quot;)</code></pre>
    <pre class="file-tag" data-tag="templates/.j2 app.py"><code>from flask import Blueprint, request, jsonify, url_for
import stripe

BASE_PRODUCT = {
    &#x27;name&#x27;: &#x27;ã¿ãŸã‚‰ã—å›£å­&#x27;,
    &#x27;price&#x27;: 600
}

TOPPINGS = {
    &#x27;kinako&#x27;: {&#x27;name&#x27;: &#x27;ããªã“&#x27;, &#x27;price&#x27;: 0},
    &#x27;matcha&#x27;: {&#x27;name&#x27;: &#x27;æŠ¹èŒ¶&#x27;, &#x27;price&#x27;: 50},
    &#x27;black&#x27;: {&#x27;name&#x27;: &#x27;é»’ã”ã¾&#x27;, &#x27;price&#x27;: 100},
    &#x27;special&#x27;: {&#x27;name&#x27;: &#x27;ç‰¹è£½&#x27;, &#x27;price&#x27;: 150},
}

checkout_bp = Blueprint(&#x27;checkout&#x27;, __name__, url_prefix=&#x27;/checkout&#x27;)

@checkout_bp.route(&#x27;/create&#x27;, methods=[&#x27;POST&#x27;])
def create():
    data = request.get_json()

    line_items = [
        {
            &#x27;price_data&#x27;: {
                &#x27;currency&#x27;: &#x27;jpy&#x27;,
                &#x27;product_data&#x27;: {&#x27;name&#x27;: &#x27;ã¿ãŸã‚‰ã—å›£å­&#x27;},
                &#x27;unit_amount&#x27;: 600,
            },
            &#x27;quantity&#x27;: 1,
        }
    ]

    for tid, item in data.items():
        topping = TOPPINGS.get(tid)
        if not topping:
            continue

        qty = min(item[&#x27;qty&#x27;], 2)

        line_items.append({
            &#x27;price_data&#x27;: {
                &#x27;currency&#x27;: &#x27;jpy&#x27;,
                &#x27;product_data&#x27;: {&#x27;name&#x27;: topping[&#x27;name&#x27;]},
                &#x27;unit_amount&#x27;: topping[&#x27;price&#x27;],
            },
            &#x27;quantity&#x27;: qty,
        })

    session = stripe.checkout.Session.create(
        mode=&#x27;payment&#x27;,
        line_items=line_items,
        success_url=url_for(&#x27;checkout.success&#x27;, _external=True),
        cancel_url=url_for(&#x27;checkout.cancel&#x27;, _external=True),
    )

    return jsonify({&#x27;url&#x27;: session.url})

@checkout_bp.route(&#x27;/success&#x27;)
def success():
    return &#x27;æ±ºæ¸ˆãŒå®Œäº†ã—ã¾ã—ãŸï¼ˆãƒ†ã‚¹ãƒˆï¼‰&#x27;

@checkout_bp.route(&#x27;/cancel&#x27;)
def cancel():
    return &#x27;æ±ºæ¸ˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ&#x27;</code></pre>
<pre class="file-tag" data-tag="app.py"><code>from flask import Blueprint, request, abort
import stripe

webhook_bp = Blueprint(&#x27;webhook&#x27;, __name__, url_prefix=&#x27;/webhook&#x27;)

ENDPOINT_SECRET = &#x27;whsec_xxxxx&#x27;

@webhook_bp.route(&#x27;/stripe&#x27;, methods=[&#x27;POST&#x27;])
def stripe_webhook():
    payload = request.data
    sig_header = request.headers.get(&#x27;Stripe-Signature&#x27;)

    try:
        event = stripe.Webhook.construct_event(
            payload, sig_header, ENDPOINT_SECRET
        )
    except Exception:
        abort(400)

    if event[&#x27;type&#x27;] == &#x27;checkout.session.completed&#x27;:
        session = event[&#x27;data&#x27;][&#x27;object&#x27;]

        # â˜… ã“ã“ã§æ³¨æ–‡ç¢ºå®š
        # order_id = save_order(session)

        print(&#x27;æ³¨æ–‡ç¢ºå®š:&#x27;, session[&#x27;id&#x27;])

    return &#x27;&#x27;, 200

</code></pre>
<h3 class="display-6 mt-5 mb-2"><i class="fa fa-cogs"></i>Application Factory</h3>
<p>Webhookã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€å¤–éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒçªç„¶èµ·ãã‚‹ãŸã‚ã€<code>create_app</code>é–¢æ•°ã§ãƒ©ãƒƒãƒ—ã™ã‚‹<code>Application Factory</code>ã¨ã„ã†ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¡ç”¨ã—ã€å‰¯ä½œç”¨ã‚’é˜²æ­¢ã™ã‚‹ã€‚ä¸­ã€œå¤§è¦æ¨¡é–‹ç™ºãƒ»æ±ºæ¸ˆï¼Webhook ã‚’æ‰±ã†å®Ÿå‹™ã‚¢ãƒ—ãƒªã§ã¯æ‹¡å¼µæ€§ã‚„å®‰å…¨é¢ã§å¿…é ˆå®Ÿè£…ã«è¿‘ãã€Flask ã‚¢ãƒ—ãƒªã‚’1å›é™ã‚Šã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ã—ãªã„ã“ã¨ã§ã€<code>dev</code>(é–‹ç™º) / <code>staging</code>(æ¤œè¨¼) / <code>prod</code>(æœ¬ç•ª)ã®åˆ‡ã‚Šæ›¿ãˆã‚„ã€ãƒ†ã‚¹ãƒˆã‚‚å˜ä½“ã§è¡Œã„ã‚„ã™ããªã‚‹ã€‚</p>
<pre class="file-tag" data-tag="app.py"><code>from flask import Flask, render_template
from checkout.routes import checkout_bp
from checkout.webhook import webhook_bp

def create_app():
    app = Flask(__name__)
    app.config[&#x27;SECRET_KEY&#x27;] = &#x27;dev-secret-key&#x27;  # æœ¬ç•ªã§ã¯ç’°å¢ƒå¤‰æ•°

    app.register_blueprint(checkout_bp)
    app.register_blueprint(webhook_bp)

    @app.route(&#x27;/&#x27;)
    def index():
        return render_template(&#x27;index.j2&#x27;)
    return app

if __name__ == &#x27;__main__&#x27;:
    app = create_app()
    app.run(debug=True)</code></pre>
{% endblock %}
