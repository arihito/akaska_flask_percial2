{% extends "admin/base.j2" %}
{% block page_title %}ユーザーサムネイル管理 | {{ SITE_NAME }}{% endblock %}
{% block content %}
    <div class="py-4">
        <h2 class="my-4 fade-in fade-delay-4">
            <i class="fa fa-picture-o me-2"></i>ユーザーサムネイル管理
        </h2>

        {# ── 横並びレイアウト ── #}
        <div class="row g-4 align-items-stretch mb-5 fade-in fade-delay-4">

            {# 左：アップロードフォーム #}
            <div class="col-12 col-md-6">
                <div class="p-4 border rounded h-100 d-flex flex-column">
                    <h5 class="fw-bold mb-3"><i class="fa fa-upload me-2"></i>サムネイルアップロード</h5>
                    <form action="{{ url_for('admin.user_thumb_upload') }}" method="POST" enctype="multipart/form-data" class="d-flex flex-column flex-grow-1">
                        {{ form.hidden_tag() }}
                        <div class="border-bottom pb-4 mb-3">
                            <label for="thumb-user-select" class="form-label fw-bold">
                                <i class="fa fa-user-circle me-1"></i>アップロード先のユーザーを選択
                            </label>
                            <select id="thumb-user-select" name="user_id" class="form-select fs-5 py-2">
                                <option value="">-- 追加のみ（ユーザーへの割付なし） --</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.username }}（{{ user.email }}）</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="thumb-file-input" class="form-label fw-bold py-2">
                                <i class="fa fa-image me-1"></i>画像を選択（png / jpg / jpeg / gif・最大5MB）
                            </label>
                            <input type="file" id="thumb-file-input" name="file" class="form-control fs-5 py-2" accept=".png,.jpg,.jpeg,.gif" required>
                        </div>
                        <div class="mt-auto">
                            <button type="submit" class="btn btn-secondary btn-lg w-100">
                                <i class="fa fa-upload me-2"></i>アップロード
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {# 右：サムネイル表示設定 #}
            <div class="col-12 col-md-6">
                <div class="p-4 border rounded h-100 d-flex flex-column">
                    <h5 class="fw-bold mb-3"><i class="fa fa-toggle-on me-2"></i>サムネイル表示設定</h5>
                    <p class="text-body-secondary small mb-3">チェックを入れたサムネイルのみ、ユーザー編集画面の選択肢に表示されます。画像自体の削除も可能です。</p>
                    <form action="{{ url_for('admin.thumbnail_visibility_update') }}" method="POST" class="thumb-visibility-form d-flex flex-column flex-grow-1">
                        {{ form.hidden_tag() }}
                        <div class="thumbnail-select d-flex flex-wrap gap-3 mb-3">
                            {% for tc in thumb_configs %}
                            <div class="thumb-item" data-filename="{{ tc.filename }}">
                                {# 削除フラグ（JSで disabled を外す） #}
                                <input type="hidden" name="delete_thumbs" value="{{ tc.filename }}" class="thumb-delete-input" disabled>
                                {# 表示ON/OFFチェックボックス #}
                                <input type="checkbox"
                                       name="visible_thumbs"
                                       id="tc-{{ loop.index }}"
                                       value="{{ tc.filename }}"
                                       class="d-none"
                                       {% if tc.visible %}checked{% endif %}>
                                <label for="tc-{{ loop.index }}" class="thumb-label position-relative d-block">
                                    <img src="{{ url_for('static', filename='images/user/' ~ tc.filename) }}"
                                         alt="{{ tc.filename }}"
                                         class="thumb-img">
                                    {# 削除プレビュー：✖オーバーレイ #}
                                    <div class="thumb-delete-overlay">
                                        <i class="fa fa-times"></i>
                                    </div>
                                </label>
                                {# 右上ゴミ箱ボタン #}
                                <button type="button" class="thumb-delete-btn" title="削除">
                                    <i class="fa fa-trash-o"></i>
                                </button>
                                <div class="text-body-secondary text-center mt-1" style="font-size:0.65rem; word-break:break-all; width:80px;">{{ tc.filename }}</div>
                            </div>
                            {% else %}
                            <p class="text-body-secondary small">画像ファイルがありません。</p>
                            {% endfor %}
                        </div>
                        <div class="mt-auto">
                            <button type="submit" class="btn btn-secondary btn-lg w-100">
                                <i class="fa fa-save me-2"></i>表示設定を保存
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>

        {# PC用テーブル #}
        <div class="table-responsive fade-in fade-in-delay-2 d-none d-md-block user-thumb-list">
            <table class="table table-striped table-hover table-sm align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>サムネイル</th>
                        <th>ユーザー名</th>
                        <th>メール</th>
                        <th>ファイル名</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr data-user-id="{{ user.id }}">
                        <td class="text-body-secondary small">{{ user.id }}</td>
                        <td>
                            <img src="{{ url_for('static', filename='images/user/' ~ user.thumbnail) }}"
                                 alt="{{ user.username }}"
                                 class="rounded-circle user-thumb"
                                 width="40" height="40"
                                 style="object-fit:cover;">
                        </td>
                        <td class="fw-bold">{{ user.username }}<span class="ms-1 text-body-secondary small fw-normal">様</span></td>
                        <td class="text-body-secondary small">{{ user.email }}</td>
                        <td class="text-body-secondary small"><code class="thumb-filename">{{ user.thumbnail }}</code></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {# スマホ用カードリスト #}
        <div class="d-md-none fade-in fade-in-delay-2 user-thumb-list">
            {% for user in users %}
            <div class="border rounded p-3 mb-3 shadow-sm d-flex align-items-center gap-3" data-user-id="{{ user.id }}">
                <img src="{{ url_for('static', filename='images/user/' ~ user.thumbnail) }}"
                     alt="{{ user.username }}"
                     class="rounded-circle flex-shrink-0 user-thumb"
                     width="52" height="52"
                     style="object-fit:cover;">
                <div class="flex-grow-1 overflow-hidden">
                    <div class="fw-bold">{{ user.username }}<span class="ms-1 text-body-secondary small fw-normal">様</span></div>
                    <div class="text-body-secondary small text-truncate">{{ user.email }}</div>
                    <code class="small text-body-secondary thumb-filename">{{ user.thumbnail }}</code>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="mt-3 fade-in fade-in-delay-3">
            <a class="btn btn-outline-secondary" href="{{ url_for('admin.index') }}"><i class="fa fa-reply me-1"></i>ダッシュボードへ戻る</a>
        </div>
    </div>
{% endblock content %}
