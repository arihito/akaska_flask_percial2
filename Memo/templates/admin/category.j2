{% extends "admin/base.j2" %}
{% block page_title %}カテゴリー管理 | {{ SITE_NAME }}{% endblock %}
{% block content %}
        <div class="d-flex align-items-center py-md-4 m-md-5 mb-5">
            <div class="col-12 col-md-6 form-signin p-md-5 mx-md-auto">
                <h1 class="fade-in fade-delay-2 mb-4"><i class="fa fa-tags me-2"></i>カテゴリー管理</h1>
            <div class="row g-4">
                {# カテゴリー一覧 #}
                <div class="col-12 fade-in fade-delay-4">
                    {% if categories %}
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>カラー</th>
                                    <th>カテゴリー名</th>
                                    <th>投稿数</th>
                                    <th>登録日時</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set weekdays = ['月', '火', '水', '木', '金', '土', '日'] %}
                                {% for cat in categories %}
                                {% set memo_count = cat.memos | length %}
                                <tr class="fade-in fade-delay-{{ loop.index * 2 }}">
                                    <td class="align-middle text-body-secondary small">{{ cat.id }}</td>
                                    <td class="align-middle">
                                        <span class="d-inline-block rounded" style="width:20px;height:20px;background-color:{{ cat.color }};border:1px solid rgba(0,0,0,.15);"></span>
                                    </td>
                                    <td class="align-middle fw-bold">
                                        <span class="badge" style="background-color:{{ cat.color }}">{{ cat.name }}</span>
                                    </td>
                                    <td class="align-middle text-body-secondary small">{{ memo_count }} 件</td>
                                    <td class="align-middle text-body-secondary small" style="font-size:11px">
                                        {{ cat.created_at.strftime("%Y/%m/%d") }}({{ weekdays[cat.created_at.weekday()] }})
                                    </td>
                                    <td class="align-middle text-end action-btn">
                                        {% if memo_count == 0 %}
                                        <form method="POST" action="{{ url_for('admin.category_delete', cat_id=cat.id) }}" class="cat-delete-form d-inline">
                                            {{ form.hidden_tag() }}
                                            <button type="submit" class="btn btn-outline-secondary btn-sm">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </form>
                                        {% else %}
                                        <span
                                            data-bs-toggle="tooltip"
                                            data-bs-placement="left"
                                            title="{{ memo_count }}件の記事で使用中のため削除できません">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" disabled>
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-body-secondary small"><i class="fa fa-info-circle me-1"></i>カテゴリーがまだ登録されていません。</p>
                    {% endif %}
                </div>
                {# 追加フォーム#}
                <div class="col-12">
                    <div class="border rounded p-4 bg-body-secondary fade-in fade-delay-14">
                        <h3 class="text-body-secondary mb-3 pb-2 fs-5 fade-in fade-delay-14 border-bottom"><i class="fa fa-plus me-1"></i>カテゴリーを追加</h3>
                        <form id="category-add-form" method="POST" action="{{ url_for('admin.category') }}" novalidate>
                            {{ form.hidden_tag() }}
                            <div class="row">
                                <div class="col-12 col-md-6 mb-1 fade-in fade-delay-16">
                                    <label for="cat-name" class="form-label small text-body-secondary">カテゴリー名　<span class="text-body-tertiary">英数字のみ・12文字以内</span></label>
                                    <input type="text" id="cat-name" name="name" class="form-control" placeholder="例: Python" maxlength="12" autocomplete="off">
                                    <div id="cat-name-error" class="form-text text-danger d-none small mt-1"></div>
                                </div>
                                <div class="col-12 col-md-6 mb-1 fade-in fade-delay-18 row">
                                    <label for="cat-color" class="col-12 form-label small text-body-secondary">カラー　<span class="text-body-tertiary">#666より暗い色</span></label>
                                    <div class="d-flex justify-content-between px-0 gap-2">
                                      <input type="color" id="cat-color" name="color" class="form-control form-control-color" value="#234466">
                                      <button id="catAiGenBtn" type="button" class="btn btn-secondary d-flex flex-nowrap justify-content-center align-items-center"
                                          {% if admin_points is not none and admin_points < 2 %}disabled title="AIポイント不足（必要: 2pt / 残: {{ admin_points }}pt）"{% endif %}>
                                          <span id="catAiGenBtnIcon"><i class="fa fa-magic me-1"></i>AI生成</span>
                                          <span id="catAiGenLoading" class="d-none"><i class="fa fa-spinner fa-spin me-1"></i>生成中</span>
                                          <small class="opacity-75 badge rounded-pill text-bg-dark ms-2 mt-1" style="font-size:0.5em;font-weight:normal">有料機能</small>
                                      </button>
                                    </div>
                                    <div id="cat-color-error" class="col-12 form-text text-danger d-none small mt-1"></div>
                                    <div id="catAiGenError" class="col-12 form-text text-danger d-none small mt-1"></div>
                                </div>
                            </div>
                            <div class="d-flex g-2 mt-4">
                                <button type="submit" id="cat-submit" class="btn btn-secondary btn-lg fade-in fade-delay-16 me-2" style="width:58%"><i class="fa fa-plus me-1"></i>追加する</button>
                                <a class="btn btn-outline-secondary btn-lg fade-in fade-delay-18" style="width:40%" href="{{ url_for('admin.index') }}"><i class="fa fa-reply"></i>ダッシュボードへ戻る</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
