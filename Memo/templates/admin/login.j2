{% extends "base.j2" %}
{% block page_title %}管理者ログイン | {{ SITE_NAME }}{% endblock %}
{% block content %}

{# ステップ判定 #}
{% if current_user.is_paid %}
    {% set current_step = 4 %}
{% elif current_user.is_admin %}
    {% set current_step = 3 %}
{% elif current_user.is_applied %}
    {% set current_step = 2 %}
{% else %}
    {% set current_step = 1 %}
{% endif %}

{% if current_step == 4 %}
{# SVG Turbulence フィルター（エレクトロニックフレーム用） #}
<svg xmlns="http://www.w3.org/2000/svg" style="position:absolute;width:0;height:0;overflow:hidden;" aria-hidden="true">
    <defs>
        <filter id="turbulent-displace" colorInterpolationFilters="sRGB" x="-20%" y="-20%" width="140%" height="140%">
            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="1"/>
            <feOffset in="noise1" dx="0" dy="0" result="offsetNoise1">
                <animate attributeName="dy" values="700; 0" dur="6s" repeatCount="indefinite" calcMode="linear"/>
            </feOffset>
            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="1"/>
            <feOffset in="noise2" dx="0" dy="0" result="offsetNoise2">
                <animate attributeName="dy" values="0; -700" dur="6s" repeatCount="indefinite" calcMode="linear"/>
            </feOffset>
            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise1" seed="2"/>
            <feOffset in="noise1" dx="0" dy="0" result="offsetNoise3">
                <animate attributeName="dx" values="490; 0" dur="6s" repeatCount="indefinite" calcMode="linear"/>
            </feOffset>
            <feTurbulence type="turbulence" baseFrequency="0.02" numOctaves="10" result="noise2" seed="2"/>
            <feOffset in="noise2" dx="0" dy="0" result="offsetNoise4">
                <animate attributeName="dx" values="0; -490" dur="6s" repeatCount="indefinite" calcMode="linear"/>
            </feOffset>
            <feComposite in="offsetNoise1" in2="offsetNoise2" result="part1"/>
            <feComposite in="offsetNoise3" in2="offsetNoise4" result="part2"/>
            <feBlend in="part1" in2="part2" mode="color-dodge" result="combinedNoise"/>
            <feDisplacementMap in="SourceGraphic" in2="combinedNoise" scale="30" xChannelSelector="R" yChannelSelector="B"/>
        </filter>
    </defs>
</svg>

{% endif %}

    <div class="d-flex align-items-center pb-md-4 m-md-5 mb-5">
        <div class="col-12 col-md-6 form-signin pb-md-5 mx-md-auto superuser-flame{% if current_step == 4 %} step-4{% endif %}">

            {# ---- Step Bar ---- #}
            <div class="step-row fade-in fade-delay-1">
                {% set steps = [
                    (1, 'fa-paper-plane', '管理者申請'),
                    (2, 'fa-clock-o',    '承認待ち'),
                    (3, 'fa-credit-card','決済'),
                    (4, 'fa-shield',     'ログイン'),
                ] %}
                {% for num, icon, label in steps %}
                    {% if num < current_step %}
                        {% set cls = 'done' %}
                    {% elif num == current_step %}
                        {% set cls = 'active' %}
                    {% else %}
                        {% set cls = '' %}
                    {% endif %}
                    <div class="step-node {{ cls }}">
                        <div class="step-icon"><i class="fa {{ icon }}"></i></div>
                        <div class="step-label">{{ label }}</div>
                    </div>
                    {% if not loop.last %}
                        <div class="progress step-bar {% if num < current_step %}done delay-{{ num }}{% endif %}">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"></div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            {# ---- End Step Bar ---- #}

            <form action="{{ url_for('admin.login') }}" method="post" novalidate>
                {% from "auth/_formhelpers.j2" import render_floating_field %}
                {{ form.hidden_tag() }}
                <h1 class="h3 mb-3 fw-normal fade-in fade-delay-1"><i class="fa fa-shield me-2"></i>管理者ログイン</h1>
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for alert_type, message in messages %}
                        {% set icon = 'exclamation-triangle' if alert_type == 'danger' else 'check' %}
                            <div class="alert alert-{{ alert_type }} text-center"><i class="fa fa-{{ icon }} me-2"></i>{{ message }}</div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                <div class="auth-process fade-in fade-delay-2">
                    <h5 class="fs-5 mb-3"><i class="fa fa-info-circle me-2"></i>管理者アクセスについて</h5>
                    <div class="row g-0">
                        {# 左：scrollspy ナビ #}
                        <div class="col-4 d-flex flex-column">
                            <div id="admin-guide-nav" class="list-group list-group-flush h-100 d-flex flex-column" style="font-size:0.9rem;">
                                <a class="list-group-item list-group-item-action flex-grow-1 d-flex align-items-center px-2" href="#guide-access">① アクセス方法</a>
                                <a class="list-group-item list-group-item-action flex-grow-1 d-flex align-items-center px-2" href="#guide-price">② 料金・有効期間</a>
                                <a class="list-group-item list-group-item-action flex-grow-1 d-flex align-items-center px-2" href="#guide-points">③ AIポイント制</a>
                                <a class="list-group-item list-group-item-action flex-grow-1 d-flex align-items-center px-2" href="#guide-notes">④ 注意事項</a>
                            </div>
                        </div>
                        {# 右：スクロール可能コンテンツ #}
                        <div class="col-8"
                             data-bs-spy="scroll"
                             data-bs-target="#admin-guide-nav"
                             data-bs-smooth-scroll="true"
                             data-bs-offset="10"
                             tabindex="0"
                             style="height:160px; overflow-y:auto; font-size:0.9rem;">
                            <h6 id="guide-access" class="fw-bold mb-1 mt-1 p-3" style="font-size:1rem"><i class="fa fa-paper-plane me-1"></i>アクセス方法</h6>
                            <ol class="ps-5 mb-2">
                                <li>運営者へ<strong>管理者申請</strong>を送信する。</li>
                                <li>承認後、<strong>決済ページ</strong>から480円を支払う。</li>
                                <li>決済完了メールに記載の<strong>トークンパスワード</strong>でログイン。</li>
                            </ol>
                            <h6 id="guide-price" class="fw-bold mb-1 pt-3 ps-3" style="font-size:1rem"><i class="fa fa-credit-card me-1"></i>料金・有効期間</h6>
                            <ul class="ps-4 mb-2">
                                <li>1回の決済：<strong>480円 / +24時間延長 / +24pt累積</strong></li>
                                <li>有効期限内であれば追加決済で<strong>時間とポイントを上積み</strong>できます。</li>
                                <li>期限切れ後の操作は<strong>ログイン画面にリダイレクト</strong>されます。</li>
                            </ul>
                            <h6 id="guide-points" class="fw-bold mb-1 p-3" style="font-size:1rem"><i class="fa fa-battery-4 me-1"></i>AIポイント制</h6>
                            <p class="ps-4 mb-1">AI機能を使用するたびにポイントを消費します。ポイントが不足するとそのAI機能は使用できなくなります（追加決済で補充可）。</p>
                            <table class="table table-sm ms-3 mb-2" style="font-size:0.9rem;width:90%">
                                <tbody>
                                    <tr><td class="p-2" style="width:80%">記事解析スコアリング</td><td class="text-end fw-bold p-2" style="width:20%">6pt</td></tr>
                                    <tr><td class="p-2">記事英語翻訳</td><td class="text-end fw-bold p-2">4pt</td></tr>
                                    <tr><td class="p-2">固定ページ生成 / カテゴリーAI提案 / サムネイル生成</td><td class="text-end fw-bold p-2">各2pt</td></tr>
                                </tbody>
                            </table>
                            <h6 id="guide-notes" class="fw-bold mb-1 ps-3 pt-3" style="font-size:1rem"><i class="fa fa-exclamation-triangle me-1"></i>注意事項</h6>
                            <ul class="ps-3 mb-1">
                                <li>残り<strong>5pt以下</strong>または<strong>3時間以下</strong>になるとページ上部に警告が表示されます。</li>
                                <li>ポイントが<strong>0</strong>になっても有効期限内であれば強制ログアウトされません。</li>
                                <li>トークンパスワードは利用期間中は同じものを使用します。</li>
                            </ul>
                        </div>
                    </div>
                </div>
                {{ render_floating_field(form.admin_password, "Token Password", wrapper_class="fade-in fade-delay-4", autofocus=True) }}
                <nav class="navbar bg-body-secondary my-3 rounded-3 fade-in fade-delay-6">
                    <div class="container-fluid justify-content-start my-2 mx-2">
                        <button type="submit" class="btn btn-lg me-2 flex-fill fade-in fade-delay-8{% if current_step == 4 %} noise-btn{% else %} btn-secondary text-dark{% endif %}">
                            <i class="fa fa-shield me-2"></i>{{ form.submit.label.text }}
                        </button>
                        <a class="btn btn-outline-secondary btn-lg me-2 fade-in fade-delay-10" href="{{ url_for('memo.index') }}"><i class="fa fa-arrow-left me-1"></i>マイページに戻る</a>
                    </div>
                </nav>
            </form>

            <div class="my-5 fade-in fade-delay-12">
                <hr class="opacity-25">
            </div>

            {% if current_user.is_admin %}
                {# 承認済み：決済ボタン表示 #}
                <div class="fade-in fade-delay-8">
                    <p class="text-body-secondary mb-3"><i class="fa fa-credit-card me-2"></i>まだ決済がお済みでない方は、こちらから決済手続きを行ってください。</p>
                    <a class="btn btn-outline-secondary btn-lg w-100" href="{{ url_for('admin.payment') }}"><i class="fa fa-credit-card me-2"></i>決済ページへ進む</a>
                </div>
            {% elif current_user.is_applied %}
                {# 申請済み・未承認：申請中メッセージ #}
                <div class="alert alert-secondary fade-in fade-delay-8">
                    <i class="fa fa-clock-o me-2"></i>申請済みです。運営者の承認をお待ちください。
                </div>
            {% else %}
                {# 未申請：申請ボタン表示 #}
                <div class="fade-in fade-delay-8">
                    <p class="text-body-secondary mb-3"><i class="fa fa-certificate me-2"></i>管理者権限を希望する方は、まず運営者に申請してください。</p>
                    <form action="{{ url_for('admin.apply') }}" method="post">
                        {{ form.hidden_tag() }}
                        <button type="submit" class="btn btn-outline-secondary btn-lg w-100"><i class="fa fa-paper-plane me-2"></i>管理者申請を送る</button>
                    </form>
                </div>
            {% endif %}

        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    /* 完了コネクターを時差付きで幅を伸ばし、到達後にストライプアニメーション開始 */
    var barDelays = { 'delay-1': 300, 'delay-2': 1050, 'delay-3': 1800 };
    Object.keys(barDelays).forEach(function (cls) {
        var bar = document.querySelector('.step-bar.done.' + cls);
        if (!bar) return;
        var fill = bar.querySelector('.progress-bar');
        var delay = barDelays[cls];
        setTimeout(function () {
            fill.style.transition = 'width 0.65s ease';
            fill.style.width = '100%';
        }, delay);
    });
});
</script>

{% endblock content %}
