# Jinja2テンプレート継承とコンポーネント化

## Jinja2テンプレートエンジンの基本

Jinja2はFlaskのデフォルトテンプレートエンジンで、Pythonライクな構文でHTMLを動的に生成できます。テンプレート継承とマクロを活用することで、DRY（Don't Repeat Yourself）原則に従った保守性の高いテンプレート設計が可能です。

## ベーステンプレートの作成

### base.html（共通レイアウト）
```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>{% block title %}デフォルトタイトル{% endblock %}</title>
    {% block head %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% endblock %}
</head>
<body>
    <header>
        {% include 'partials/navbar.html' %}
    </header>
    
    <main>
        {% block content %}
        <!-- 子テンプレートでここを上書き -->
        {% endblock %}
    </main>
    
    <footer>
        {% block footer %}
        <p>&copy; 2024 My Application</p>
        {% endblock %}
    </footer>
    
    {% block scripts %}
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% endblock %}
</body>
</html>
```

## テンプレート継承の実装

### 子テンプレート（index.html）
```html
{% extends "base.html" %}

{% block title %}ホーム | My Application{% endblock %}

{% block content %}
<div class="container">
    <h1>ようこそ</h1>
    <p>これはホームページです。</p>
</div>
{% endblock %}
```

### 部分的な上書き
```html
{% extends "base.html" %}

{% block scripts %}
{{ super() }}  <!-- 親のscriptsを継承 -->
<script src="{{ url_for('static', filename='js/custom.js') }}"></script>
{% endblock %}
```

## includeによる部分テンプレート

### navbar.html（共通ナビゲーション）
```html
<nav class="navbar">
    <a href="{{ url_for('index') }}">ホーム</a>
    {% if current_user.is_authenticated %}
        <a href="{{ url_for('profile') }}">プロフィール</a>
        <a href="{{ url_for('logout') }}">ログアウト</a>
    {% else %}
        <a href="{{ url_for('login') }}">ログイン</a>
    {% endif %}
</nav>
```

### 使用例
```html
{% include 'partials/navbar.html' %}
```

## マクロによる再利用可能コンポーネント

### macros.html
```html
{% macro render_input(name, label, type='text', required=False) %}
<div class="form-group">
    <label for="{{ name }}">{{ label }}</label>
    <input type="{{ type }}" 
           name="{{ name }}" 
           id="{{ name }}"
           {% if required %}required{% endif %}>
</div>
{% endmacro %}

{% macro render_pagination(pagination) %}
<nav>
    <ul class="pagination">
        {% if pagination.has_prev %}
        <li><a href="?page={{ pagination.prev_num }}">前へ</a></li>
        {% endif %}
        
        {% for page in pagination.iter_pages() %}
            {% if page %}
                <li class="{% if page == pagination.page %}active{% endif %}">
                    <a href="?page={{ page }}">{{ page }}</a>
                </li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <li><a href="?page={{ pagination.next_num }}">次へ</a></li>
        {% endif %}
    </ul>
</nav>
{% endmacro %}
```

### マクロの使用
```html
{% from 'macros.html' import render_input, render_pagination %}

<form method="POST">
    {{ render_input('username', 'ユーザー名', required=True) }}
    {{ render_input('email', 'メールアドレス', type='email', required=True) }}
    <button type="submit">登録</button>
</form>

{{ render_pagination(articles) }}
```

## 条件分岐とループ

### 条件分岐
```html
{% if user.is_admin %}
    <a href="{{ url_for('admin') }}">管理画面</a>
{% elif user.is_authenticated %}
    <p>ようこそ、{{ user.username }}さん</p>
{% else %}
    <p>ゲストユーザー</p>
{% endif %}
```

### ループ処理
```html
<ul>
{% for article in articles %}
    <li>
        <h3>{{ article.title }}</h3>
        <p>{{ article.content|truncate(100) }}</p>
        {% if loop.first %}<span>NEW!</span>{% endif %}
    </li>
{% else %}
    <li>記事がありません</li>
{% endfor %}
</ul>
```

## フィルターの活用

### 組み込みフィルター
```html
{{ article.title|upper }}  <!-- 大文字変換 -->
{{ article.created_at|strftime('%Y年%m月%d日') }}  <!-- 日付フォーマット -->
{{ article.content|safe }}  <!-- HTMLエスケープ解除 -->
{{ article.body|truncate(200) }}  <!-- 200文字で切り詰め -->
```

### カスタムフィルター
```python
# app.py
@app.template_filter('jst')
def jst_filter(dt):
    return dt.strftime('%Y年%m月%d日 %H:%M')

# テンプレート
{{ article.created_at|jst }}
```

## まとめ

Jinja2のテンプレート継承、include、マクロを適切に組み合わせることで、保守性が高く再利用可能なテンプレート構造を構築できます。特にマクロは、フォーム要素やページネーションなど繰り返し使用するコンポーネントの作成に非常に有効です。
