# HTMXによる非同期UI構築

## HTMXとは

HTMXは、JavaScriptを書かずにHTML属性だけで動的なWebアプリケーションを構築できるライブラリです。Flaskとの相性が非常に良く、シンプルなコードで高度なUI/UXを実現できます。

## セットアップ

### CDN経由での読み込み
```html
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
```

## 基本的な使い方

### AJAX GET リクエスト

```html
<button hx-get="/api/users" hx-target="#result">
    ユーザー一覧を取得
</button>
<div id="result"></div>
```

Flaskルート：
```python
@app.route('/api/users')
def get_users():
    users = User.query.all()
    return render_template('partials/user_list.html', users=users)
```

### POST リクエスト

```html
<form hx-post="/users" hx-target="#users">
    <input type="text" name="username" required>
    <button type="submit">登録</button>
</form>
<div id="users"></div>
```

## 実践例：削除機能の実装

### HTMLテンプレート
```html
{% for item in items %}
<div id="item-{{ item.id }}">
    <h3>{{ item.title }}</h3>
    <button hx-delete="/items/{{ item.id }}" 
            hx-target="#item-{{ item.id }}"
            hx-swap="outerHTML"
            hx-confirm="本当に削除しますか？">
        削除
    </button>
</div>
{% endfor %}
```

### Flaskビュー
```python
@app.route('/items/<int:id>', methods=['DELETE'])
def delete_item(id):
    item = Item.query.get_or_404(id)
    db.session.delete(item)
    db.session.commit()
    return '', 200  # 空のレスポンスを返す
```

## トリガーとターゲット

### hx-trigger（実行タイミング）
```html
<!-- クリック時（デフォルト） -->
<button hx-get="/data" hx-trigger="click">取得</button>

<!-- ページ読み込み時 -->
<div hx-get="/init" hx-trigger="load"></div>

<!-- 入力変更時（遅延付き） -->
<input hx-get="/search" 
       hx-trigger="keyup changed delay:500ms" 
       name="q">
```

### hx-swap（置き換え方法）
```html
<!-- 内部を置き換え（デフォルト） -->
<div hx-get="/content" hx-swap="innerHTML"></div>

<!-- 要素自体を置き換え -->
<div hx-get="/content" hx-swap="outerHTML"></div>

<!-- 前後に追加 -->
<div hx-get="/more" hx-swap="beforeend"></div>
```

## インジケーター表示

### ローディング表示
```html
<button hx-get="/slow-api" hx-indicator="#spinner">
    データ取得
</button>
<div id="spinner" class="htmx-indicator">
    読み込み中...
</div>
```

CSS:
```css
.htmx-indicator {
    display: none;
}
.htmx-request .htmx-indicator {
    display: inline;
}
```

## 無限スクロールの実装

```html
<div id="items">
    {% for item in items %}
    <div class="item">{{ item.title }}</div>
    {% endfor %}
</div>

<div hx-get="/items?page=2" 
     hx-trigger="revealed" 
     hx-swap="afterend">
    <span class="loading">読み込み中...</span>
</div>
```

## Flaskでのレスポンス最適化

### 部分テンプレートの活用
```python
@app.route('/items')
def items():
    page = request.args.get('page', 1, type=int)
    items = Item.query.paginate(page=page, per_page=10)
    
    # HTMXリクエストの場合は部分テンプレート
    if request.headers.get('HX-Request'):
        return render_template('partials/items.html', items=items)
    
    # 通常のリクエストは完全なページ
    return render_template('items.html', items=items)
```

## まとめ

HTMXを使うことで、JavaScriptフレームワークを導入することなく、モダンなSPA風のUIを構築できます。Flaskのテンプレートエンジンとの親和性が高く、シンプルなコードで高度なインタラクションを実現できる点が大きな利点です。

## HTMXのイベントシステム

HTMXはリクエストのライフサイクルに応じたイベントを発火します。JavaScriptと組み合わせることで柔軟な処理が可能です。

```javascript
// リクエスト開始時にローディング表示
document.addEventListener('htmx:beforeRequest', (e) => {
    document.getElementById('loading').classList.remove('d-none');
});

// レスポンス受信後にローディング非表示
document.addEventListener('htmx:afterRequest', (e) => {
    document.getElementById('loading').classList.add('d-none');
});
```

`htmx:beforeSwap` ではHTTPステータスコードに応じた条件分岐も可能で、エラーレスポンス時に特定の処理を実行できます。

## リアルタイム更新とSSE

HTMXはServer-Sent Events（SSE）にも対応しており、サーバーからのプッシュ通知をシンプルに実装できます。

```html
<div hx-ext="sse" sse-connect="/stream" sse-swap="message">
    <p>最新の通知がここに表示されます</p>
</div>
```

```python
# Flask側のSSEエンドポイント
import time
from flask import Response

@app.route('/stream')
def stream():
    def event_stream():
        while True:
            yield f"data: {get_latest_notification()}\n\n"
            time.sleep(5)
    return Response(event_stream(), mimetype='text/event-stream')
```

ポーリングと異なりサーバーからのプッシュができるため、通知システムやダッシュボードのリアルタイム更新に適しています。

## フォームバリデーションのリアルタイム化

HTMX を使うと、サーバーサイドのバリデーションをリアルタイムで行えます。

```html
<input type="text" name="username"
       hx-post="/validate/username"
       hx-trigger="keyup changed delay:400ms"
       hx-target="#username-error">
<div id="username-error"></div>
```

```python
@app.route('/validate/username', methods=['POST'])
def validate_username():
    username = request.form.get('username', '')
    if User.query.filter_by(username=username).first():
        return '<span class="text-danger">このユーザー名は使用中です</span>'
    return '<span class="text-success">使用可能です</span>'
```

400msのデバウンスを設定することで、入力のたびにリクエストが飛ぶことを防ぎながら、リアルタイムに近いフィードバックを提供できます。
