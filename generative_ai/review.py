import os
from dotenv import load_dotenv
import google.generativeai as genai  # Googleの生成AIライブラリ
import pandas as pd  # データ分析ライブラリ
import json
import time
from tqdm import tqdm
from collections import Counter
import matplotlib.pyplot as plt
import re

# matplotlibの文字コード設定
plt.rcParams["font.family"] = "MS Gothic"
plt.rcParams["axes.unicode_minus"] = False


#------------------------------------------
#　APIのセットアップ
#------------------------------------------
load_dotenv()
GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY")
genai.configure(api_key=GOOGLE_API_KEY)

#------------------------------------------
#　Geminiのモデルの選択
#------------------------------------------
model = genai.GenerativeModel("models/gemini-2.5-flash-lite")
print(f"選択されたモデル: {model.model_name}")

#------------------------------------------
#　レビューデータをセット
#------------------------------------------
reviews = [
    "数か月使用した時点でのレビューです。低音強めでパンチがありますが、高音がこもりがちです。外観は高級感があり、ケーブルも絡まりにくいです。",
    "全体的に満足しています。梱包の箱が壊れていたのは残念ですが、音質は期待以上で、クリアでバランスの取れたサウンドを楽しめます。価格は手頃で、各サイズのイヤーピースが付属しているのも便利です。長時間の使用に耐えられるかどうかはまだわかりませんが、予備のイヤホンとしては最適な選択肢だと思います。",
    "梱包の段ボールが破損して届いた。中身は問題なかった",
    "低音は豊かでパンチがありますが、高音は少しこもってしまいます。ケーブルがもつれやすいのも気になります。",
    "装着感は良いですが、ノイズキャンセリングは微妙です。",
    # "長年使用しているイヤホンが壊れたためこちらの商品を購入しました。音質は価格相応です。長時間使用しても耳が痛くなることはありませんでしたが、少し音がこもったような感じがあります。",
    # "中間レベルの音質で、用途によってはお勧めできます。他製品より低音が強調されていますが、ノイズキャンセリング機能は期待以下です。",
    # "音質はまあまあ良い。でも、耳が痛くなるのが難点。長時間は使えない。あと、届いた箱がつぶれていたのが残念。",
    # "音質が良い。価格以上です。",
    # "正直にレビューすると、あまり期待していなかったのですが、このイヤホンは予想外に良かったです。音質は素晴らしく、音楽が生き生きと聞こえます。また、フィット感も良く、長時間使用しても耳が痛くなりません。他のイヤホンと比較すると、このイヤホンは間違いなくお買い得です。ただし、箱が少し壊れて届いたのが残念です。",
    # "色は画像通りの高級感があり、音も重低音が効いてて聴いていて楽しいです。ただし、ワイヤレスイヤホンからの買い替えのため、コードの長さが不便に感じてしまうことがあります。",
    # "柔らかいシリコンイヤーチップが耳にフィットし、快適な装着感です。音質はクリアで迫力があり、低音もしっかりと響きます。",
    # "遮音性が優れており、周囲の音に遮られることなく音楽に没頭できます。音質もクリアでバランスが良く、低音から高音まで忠実に再現してくれます。また、軽量で長時間つけていても負担になりません。",
    # "耳に快適にフィットし、遮音性に優れています。音質はクリアでバランスが取れており、周囲の雑音をシャットアウトしてくれます。",
    # "耳によくフィットし、装着感が良くて長時間でも快適に聴けます。音質もクリアで、低音から高音までバランスが良く、音楽や映画鑑賞に最適です。",
    # "耳にしっかりフィットし、音質もクリアでバランスが取れています。また、コードが絡みにくくて便利です。",
    # "思ったより音質良かった！低音もちゃんと出てるし、高音も刺さらない。耳への収まりも良く長時間つけてても痛くならない。ただ、ケースがちょっと安っぽいのが残念。",
    # "雑音がほとんどなく、低音域も良く効いています。デザインもシンプルで飽きません。この価格帯でここまでの満足感が得られるとは思っていませんでした。",
    # "音質はフラットな印象。高音から低音までバランスよく再生されるが、少しこもった感じも。装着感は普通で、耳への負担は特に感じられない。耐久性は未知数だが、コードがやや細いため、取り扱いは注意が必要かも。",
    # "今まで使っていたイヤホンが壊れたのでこちらの商品を購入しました。ワイヤレスイヤホンも検討しましたが、音質重視で有線のものに決めました。接続も簡単で、低音から高音までバランスよく聞こえます。ただ、届いた時に箱に一部破損がありましたので、星を一つ減らしました。",
    # "ノイズキャンセリングが微妙、カフェでは結構話し声が聞こえる。",
    # "軽くて耳にフィットし、長時間つけても快適でした。音質もクリアでバランスが取れています。",
    # "久々に良いイヤホンに出会えました！音質は文句なし。特に低音の響き方がすごく好みです。つけていて耳が痛くなったり疲れにくいところも◎。ただ、コードが絡まりやすいのが難点です。",
    # "低音が力強く、音楽が楽しめます。ただひとつ、梱包の傷が気になりました",
    # "快適な着用感で長時間でも耳が痛くなりません。音質はシャープでバランスが取れており、価格帯を考えると非常に素晴らしいです。",
    # "快適な装着感で長時間使用しても疲れにくく、密閉性が高いので周囲のノイズを遮断し、音楽に集中できます。音質は明瞭でバランスが良く、幅広いジャンルの音楽を豊かに楽しめました。",
    # "価格帯を考慮すると、音質は驚くほど良好です。装着感も快適で、長時間にわたる使用でも耳に負担がかかりません。唯一の欠点は、コードがやや絡まりやすいことです。",
    # "音質重視で有線イヤホンを購入。思いの外、高音から低音までバランスよく鳴ってくれるので満足しています。また、4種類のイヤーピースが付属しており、自分の耳にフィットするものを選択できるのも嬉しいポイント。ただ、耐久性はあまり良さそうではないので、慎重に扱おうと思います。",
    # "コードが絡まりやすいので使いづらいです。また、イヤーピースがすぐに外れてしまいます。また、到着時に既に梱包の箱がつぶれていました",
    # "音質は値段以上の出来栄えで、特に中音域が際立っています。装着感は良好で、長時間装着しても快適です。ただ、マイクの感度がイマイチで、通話時に相手の声が聞き取りづらいことがあります。",
    # "音質は想定より良かった。ベースはちょっと強調されすぎているかな。耳の形状によると思いますが、自分はノイズキャンセルがうまく作動しなかったです。長時間の使用には向きませんが、音楽の鑑賞には十分だと思います。外出時に使用する分には問題ないので、コスパは良いと思います。",
    # "音質は素晴らしいですね。立体感があり、楽器やボーカルがクリアに聞こえます。長時間つけていても耳が痛くならないのも気に入りました。ただ、コードが少し短いのが気になります。",
    # "耐久性がありません。わずか数回の使用で、片方のイヤホンから音がほとんど出なくなりました。",
    # "ケーブルがやや細く、絡まりやすい。また、イヤーピースが少し大きいため、長時間使用すると耳が疲れる。総合的には、値段相応の音質と使い勝手。",
    # "音質はしっかりとしていて、価格以上の価値があります。耳の形に合うようにさまざまなサイズのイヤーピースが付属しているのも嬉しいです。しかし、コードが少し短く、耐久性が心配です。",
    # "音質には驚きました！この価格帯では最高のイヤホンと言えるでしょう。高音から低音までバランスが取れていて、楽器の音色もクリアに聞こえます。イヤーピースのサイズも豊富で、フィット感も抜群。ただ、少し音が大きいので、電車内などでは注意が必要かもしれません。",
    # "装着感は良く、音質も良いです。",
    # "ノイキャンを期待して購入しましたが、イマイチでした。また、装着感が悪く、耳から外れることが多々ありました。デザインはスタイリッシュで格好良かったですが、それ以外の点は期待外れです。",
    # "シンプルで丈夫なデザインで、快適に装着できます。クリアな音質で、音楽を純粋に楽しむことができます。",
    # "しっかりした作りで耐久性がありそうな印象。音質は価格帯の割に良い。耳へのフィット感も良く、長時間の装着でも快適。",
    # "コンパクトで持ち運びに便利。音質も価格帯の割に良く、ボーカルがクリアに聞こえる。",
    # "この有線のイヤホンは、期待以上に音質が優れていました。高音と低音がバランス良く聞こえ、各サイズのイヤーピースのおかげでフィット感も抜群です。また、この価格でこの音質はかなりお得だと思います。パッケージの箱が壊れていて少し残念でしたが、イヤホンの品質は文句なしです。",
    # "このイヤホンは音質がとても良く、高音も低音もバランス良く聞こえます。各サイズのイヤーピースが付属しているため、自分の耳に合ったものを使うことができます。この価格でこの性能はコスパに優れていると思います。",
    # "このイヤホンは安いのにめちゃくちゃ音質が良いです。安いイヤホンでありがちな”高音重視”ではなく、低音もそこそこ出ていて聴き疲れしないバランスの良い音質だと思います。この価格ではコスパ最強だと思います。",
    # "このイヤホンは、自宅や外出先で音楽を楽しむのに最適です。音質が素晴らしく、低音から高音までバランスよくカバーしています。さらに、イヤーフックのフィット感が抜群で、激しい運動中でもずれ落ちません。ただ、付属のケースがややかさばるため、持ち運びには少し不便かもしれません。総じて、このイヤホンは音楽愛好家にとって素晴らしい選択肢だと思います。",
    # "このイヤホンの音質は、正直期待以上でした。クリアでバランスのとれたサウンドで、音楽も聴きやすくて楽しかったです。ただし、付属のイヤーピースが耳に合わず、長時間使用していると圧迫感がありました。また、マイクの音質も若干こもっている印象でした。",
    # "このイヤホンには期待していませんでしたが、驚くほど音質が良かったです。高音も低音もクリアでバランスが良く、まるで目の前で演奏されているかのような臨場感がありました。",
    # "長時間使用しても耳が痛くなることがなく、とても快適でした。唯一欠点を挙げるとすれば、見た目が少し安っぽく感じることでしょうか。しかし、この音質でこの価格は十分すぎるほどだと思います。",
    # "クリアで豊かなサウンド。快適で、外出先でも快適に使えます。",
    # "イヤホンが届いたんですが、もうびっくりするくらい音がクリア！高音が刺さらないのにしっかり聴こえるし、低音もドッシリ響いて迫力ある音。しかもこの値段でこの音質なら大満足！ただ、ケースがちょっとチープな感じかな…。あと、ケーブルが少し長すぎるかも。でも、それ以外は言うことなし！"
]
# 表形式に変換
df = pd.DataFrame({
    'レビュー文': reviews
})

#-------------------------------------------------
#　#7.レビューテキストの前処理:データ分析の際の儀式
#-------------------------------------------------
df['レビュー文'] = df['レビュー文'].str.replace('\n', '', regex=False)   # 改行のみを削除
df['レビュー文'] = df['レビュー文'].str.replace('、', '', regex=False)   # 句点のみを削除
df['レビュー文'] = df['レビュー文'].str.replace('[！？]', '。', regex=True) # ビックリマークと疑問符を句点に変更

#---------------------------------------------------
#　#8.Geminiでテキスト生成　1件分のレビュー結果
#---------------------------------------------------
# (3) LLMのモデルとプロンプトを受け取る
def generate_content(model, prompt, temperature=0.0):
    config = genai.GenerationConfig(
        max_output_tokens=2048,
        temperature=temperature
    )
    while True:
        try:
            # generative_aiの持つgenerate_contentで総評リストを作成
            response = model.generate_content(prompt, generation_config=config)
            return response.text
        # 処理が多い場合はメッセージを出力
        except Exception as e:
            if "429" in str(e):
                print("1分間に使用できる上限に到達しました。1分間待機して処理を続行します。")
                time.sleep(60)
            else:
                raise e


#---------------------------------------------------
#　#9.レビューテキストから要素を抽出する関数　レビュー文1件分の分析結果(JSON)
#---------------------------------------------------
# (2) 高評価と低評価での返答パターンを提示した上で辞書で返す
def extract_review_elements(model, review_text):
    prompt = f"""
    以下のテキストから高評価要素と低評価要素を分析してください。
    結果は必ず次のJSON形式で返してください。他の説明や文章は不要です。

    テキスト: 音質は素晴らしかった。長時間使用しても疲れず、耳にもフィットして快適でした。
    {{
        "高評価要素": ["音質", "装着感"],
        "低評価要素": []
    }}

    テキスト: 迫力がなく音がスカスカ。音漏れが酷く電車などの公共の場で使えないレベル。
    {{
        "高評価要素": [],
        "低評価要素": ["音質", "音漏れ"]
    }}

    テキスト: 値段を考えると音質はまあまあ良い。でも耳が痛くなるのが難点。長時間は使えない。あと届いた箱がつぶれていたのが残念。
    {{
        "高評価要素": ["音質"],
        "低評価要素": ["装着感", "梱包"]
    }}

    テキスト: {review_text}
    """
    # モデルとプロンプトを渡しサマリーのリストを作成
    response = generate_content(model, prompt)
    json_match = re.search(r'\{.*\}', response, re.DOTALL)
    if json_match:
        json_str = json_match.group(0)
        try:
            # JSONとして解析できるか確認
            parsed_json = json.loads(json_str)
            # 期待するキーが含まれているか確認
            if "高評価要素" in parsed_json and "低評価要素" in parsed_json:
                return json.dumps(parsed_json, ensure_ascii=False, indent=4)
        except json.JSONDecodeError:
            pass
    # 有効なJSONが見つからなかった場合、デフォルト値を返す
    default_json = {"高評価要素": [], "低評価要素": []}
    return json.dumps(default_json, ensure_ascii=False, indent=4)

#---------------------------------------------------
#　#10.データフレームのレビューを処理して結果を追加　LLMのモデル：全レビューの分析結果(JSON)
#---------------------------------------------------
# (1) LLMのモデル(gemini)とデータフレーム(リストテーブルデータ)を受けて上記のextract_review_elementsに渡す。
def analyze_reviews(df, model):
    # JSONに変換
    json_data = json.loads(df.to_json(orient='records'))
    # tqdmはカラムバーを表示
    for review in tqdm(json_data, desc='レビュー文をGeminiで分析中'):
        result = extract_review_elements(model, review['レビュー文'])
        review.update(json.loads(result))
    return json_data

#---------------------------------------------------
#　#11.カウント結果をプロット
#---------------------------------------------------
def plot_elements(elements, title, color, subplot_index):
    elements.sort(key=lambda x: x[1], reverse=True)
    labels, values = zip(*elements)
    plt.subplot(1, 2, subplot_index)
    plt.title(title)
    bars = plt.barh(labels, values, color=color)
    for bar in bars:
        plt.text(bar.get_width() - bar.get_width() * 0.5, bar.get_y() + bar.get_height() / 2,
            f'{bar.get_width()}', va='center', color='white', fontweight='bold', fontfamily='MS Gothic')
    plt.gca().invert_yaxis()
    plt.tight_layout()

#-----------------------------------------------------------
#　#12.特定した高評価と低評価の要素を基に簡単なレポートを作成
#-----------------------------------------------------------
def summarize_review_elements(review_elements, model):
    prompt = f"""
        以下はイヤホンに関するレビューで集計された高評価の要素と、低評価の要素です。このイヤホンの評価をまとめてください。
        例：ユーザーはこのスマートウォッチの操作性とバッテリー寿命を高く評価しています。ただし、価格に対しては低評価が多くなっています。また、防水機能に関しては高評価と低評価、両方の意見が寄せられています。
        {review_elements}"""
    response = generate_content(model, prompt)
    response += "\n以下にユーザーからの高評価・低評価の要素のグラフを表示します。"
    return response

#-----------------------------------------------------------
#　#13.メイン処理
#-----------------------------------------------------------
reviews_json = analyze_reviews(df, model)
# 高評価上位5件取得
top_5_high_elements = Counter([element for review in reviews_json for element in review["高評価要素"]]).most_common(5)
# 低評価下位5件取得
top_5_low_elements = Counter([element for review in reviews_json for element in review["低評価要素"]]).most_common(5)

review_elements = f"高評価レビューの主要要素:{top_5_high_elements}\n低評価レビューの主要要素:{top_5_low_elements}"
summary_review_elements = summarize_review_elements(review_elements, model)
print("\n-----分析結果レポート-----")

print(summary_review_elements)

print("\n-----分析結果のグラフ-----")
plt.figure(figsize=(10, 5))
plot_elements(top_5_high_elements, '高評価レビューの主要要素', '#3652AD', 1)
plot_elements(top_5_low_elements, '低評価レビューの主要要素', '#FE7A36', 2)
plt.show()